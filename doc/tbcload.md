# Tcl Bytecode Loader (tbcload)

A Tcl extension for loading and executing precompiled Tcl bytecode files (.tbc).

**Version:** 2.0a0 \
**Package:** `tbcload` \
**Namespace:** `::tbcload` (internal)

---

## Table of Contents

1. [Overview](#overview)
2. [Features](#features)
3. [Requirements](#requirements)
4. [Installation](#installation)
5. [Quick Start](#quick-start)
6. [API Reference](#api-reference)
   - [Loading Bytecode](#loading-bytecode)
7. [Usage Examples](#usage-examples)
8. [Compatibility](#compatibility)
9. [Security Considerations](#security-considerations)
10. [Performance Considerations](#performance-considerations)
11. [Troubleshooting](#troubleshooting)
12. [Building from Source](#building-from-source)
13. [Platform Support](#platform-support)
14. [License](#license)
15. [Version History](#version-history)
16. [Additional Resources](#additional-resources)

---

## Overview

The **tbcload** package implements commands to load and execute Tcl bytecode files generated by the **tclcompiler** package. Bytecode compilation allows you to:

- **Protect source code** - Distribute applications without exposing plain-text Tcl source
- **Reduce startup time** - Skip the parsing phase for large applications
- **Hide implementation details** - Obscure proprietary algorithms from end users
- **Package applications** - Integrate with packaging tools for standalone executables

The package transparently extends Tcl's `source` command to recognize and load `.tbc` (Tcl ByteCode) files in addition to regular `.tcl` script files.

## Features

- **Transparent bytecode loading** - Uses standard `source` command
- **Tcl 8.6 and 9.0 support** - Compatible with modern Tcl versions
- **Platform support** - Works on Windows, Linux, macOS, and Unix systems
- **Integration with packaging tools** - Compatible with CooKit, tclexecomp, and other packagers
- **Native performance** - Compiled C implementation for efficient bytecode execution
- **TEA-compliant build system** - Standard Tcl Extension Architecture

## Requirements

### Software Requirements

- **Tcl 8.6 or later** or **Tcl 9.0** - Required for runtime execution
- **tclcompiler 2.0 or later** - For generating `.tbc` bytecode files (separate package)

### Important Compatibility Notes

- **Version matching required:** Bytecode files compiled for Tcl 8.x cannot be loaded in Tcl 9.x and vice versa
- **Compiler version:** Use tclcompiler 2.0 or later; earlier versions are unsupported
- **Platform-specific binaries:** The tbcload extension contains native code and must match your platform and Tcl ABI

### Supported Platforms

- Windows (32-bit and 64-bit)
- Linux (32-bit and 64-bit)
- macOS
- BSD (FreeBSD, OpenBSD, NetBSD)
- Other Unix systems (Solaris, AIX, HP-UX)

---

## Installation

### Using Package Managers

**Tcl Dev Kit:**
Many Tcl Dev Kit distributions include tbcload pre-installed.

**Linux distributions:**
```bash
# Fedora/RHEL/CentOS
sudo dnf install tbcload

# Debian/Ubuntu (if available in repositories)
sudo apt-get install tbcload
```

### From Binary Distribution

1. Obtain a pre-built tbcload binary for your platform and Tcl version
2. Extract to a directory on your Tcl `auto_path`
3. Ensure the directory contains both the shared library and `pkgIndex.tcl`

### Verifying Installation

```tcl
package require tbcload
puts "tbcload version: [package require tbcload]"
```

---

## Quick Start

### Step 1: Compile a Tcl Script to Bytecode

Create a simple Tcl script:

```tcl
# hello.tcl
proc greet {name} {
    puts "Hello, $name!"
}

greet "World"
```

Compile it to bytecode:

```tcl
package require tclcompiler
compiler::compile hello.tcl
# Creates hello.tbc
```

### Step 2: Load and Execute the Bytecode

```tcl
package require tbcload
source hello.tbc
# Output: Hello, World!
```

That's it! The bytecode is executed transparently as if you had sourced the original `.tcl` file.

---

## API Reference

### Loading Bytecode

The `tbcload` package works transparently by extending Tcl's built-in `source` command. You don't call tbcload functions directly; instead, you use the standard Tcl commands.

#### `source` (extended)

Once tbcload is loaded, the `source` command automatically detects and loads `.tbc` bytecode files.

**Syntax:**
```tcl
source filename.tbc
```

**Parameters:**

- `filename.tbc` - Path to a compiled Tcl bytecode file

**Returns:** Result of executing the bytecode script

**Behavior:**

- If the file extension is `.tbc`, tbcload handles it
- If the file contains valid bytecode matching the interpreter version, it executes
- If there's a version mismatch or corruption, an error is raised

**Example:**
```tcl
package require tbcload

# Load compiled bytecode
source myapp.tbc

# Works in nested contexts too
namespace eval ::myapp {
    source components/database.tbc
    source components/ui.tbc
}
```

**Notes:**

- The file must be compiled for the same major Tcl version (8.x or 9.x)
- Bytecode is executed in the same context as a regular `source` would be
- All procedures, variables, and namespaces are created as if from source

---

## Usage Examples

### Example 1: Basic Script Compilation and Execution

Compile and run a simple application:

**Original script (calculator.tcl):**
```tcl
# calculator.tcl
namespace eval ::calc {
    proc add {a b} {
        return [expr {$a + $b}]
    }

    proc multiply {a b} {
        return [expr {$a * $b}]
    }
}

# Test
puts "5 + 3 = [::calc::add 5 3]"
puts "5 * 3 = [::calc::multiply 5 3]"
```

**Compile to bytecode:**
```tcl
package require tclcompiler
compiler::compile calculator.tcl
# Creates calculator.tbc
```

**Run the bytecode:**
```tcl
package require tbcload
source calculator.tbc
# Output:
# 5 + 3 = 8
# 5 * 3 = 15
```

---

### Example 2: Application with Multiple Modules

Structure a larger application with compiled modules:

**Project structure:**
```
myapp/
  ├── main.tcl (compiled to main.tbc)
  ├── lib/
  │   ├── database.tcl (compiled to database.tbc)
  │   ├── ui.tcl (compiled to ui.tbc)
  │   └── utils.tcl (compiled to utils.tbc)
  └── pkgIndex.tcl
```

**Compile all modules:**
```tcl
package require tclcompiler

# Compile main application
compiler::compile myapp/main.tcl

# Compile library modules
foreach script {database ui utils} {
    compiler::compile myapp/lib/${script}.tcl
}
```

**Main application (main.tbc):**
```tcl
# Original main.tcl
package require tbcload

# Load compiled library modules
source [file join [file dirname [info script]] lib database.tbc]
source [file join [file dirname [info script]] lib ui.tbc]
source [file join [file dirname [info script]] lib utils.tbc]

# Application logic
::ui::createMainWindow
::database::connect
```

**Run the application:**
```tcl
package require tbcload
source myapp/main.tbc
```

---

### Example 3: Creating a Package with Compiled Code

Create a package that loads bytecode automatically:

**pkgIndex.tcl:**
```tcl
# pkgIndex.tcl for MyPackage
package ifneeded MyPackage 1.0 [list apply {{dir} {
    package require tbcload
    source [file join $dir mypackage.tbc]
}} $dir]
```

**Usage:**
```tcl
lappend auto_path /path/to/MyPackage
package require MyPackage
# Bytecode is loaded automatically
```

---

### Example 4: Conditional Loading (Source or Bytecode)

Load bytecode if available, otherwise fall back to source:

```tcl
proc load_module {name} {
    set basepath [file join lib $name]
    set tbcfile "${basepath}.tbc"
    set tclfile "${basepath}.tcl"

    if {[file exists $tbcfile]} {
        # Load compiled bytecode
        package require tbcload
        source $tbcfile
        puts "Loaded $name from bytecode"
    } elseif {[file exists $tclfile]} {
        # Fall back to source
        source $tclfile
        puts "Loaded $name from source"
    } else {
        error "Module $name not found"
    }
}

# Load modules
load_module database
load_module ui
load_module utils
```

---

### Example 5: Embedding in Standalone Executable

Package bytecode into a standalone executable using a packaging tool:

```tcl
# build_executable.tcl
package require tbcload
package require tclcompiler

# Compile all application files
foreach script [glob src/*.tcl] {
    compiler::compile $script
}

# Use packaging tool (example with freewrap/tclkit)
exec tclkit freewrap.tcl \
    -o myapp.exe \
    -f main.tbc \
    -f lib/*.tbc \
    -f [info library]/../tbcload*/tbcload[info sharedlibextension]
```

---

### Example 6: Batch Compilation Script

Compile an entire project tree:

```tcl
package require tclcompiler

proc compile_directory {dir {pattern *.tcl}} {
    set count 0
    foreach file [glob -nocomplain -directory $dir $pattern] {
        if {[file isfile $file]} {
            puts "Compiling: $file"
            if {[catch {
                compiler::compile $file
                incr count
            } err]} {
                puts stderr "Error compiling $file: $err"
            }
        }
    }

    # Recurse into subdirectories
    foreach subdir [glob -nocomplain -directory $dir -type d *] {
        incr count [compile_directory $subdir $pattern]
    }

    return $count
}

# Compile entire project
set total [compile_directory ./src]
puts "Compiled $total files to bytecode"
```

---

## Compatibility

### Version Compatibility

**Critical:** Bytecode files are **not compatible** across major Tcl versions:

| Compiled With | Can Load In Tcl 8.6 | Can Load In Tcl 9.0 |
|---------------|---------------------|---------------------|
| tclcompiler for Tcl 8.x | ✓ Yes | ✗ No |
| tclcompiler for Tcl 9.x | ✗ No | ✓ Yes |

### Compiler Version Requirements

- **Supported:** tclcompiler 2.0 or later
- **Unsupported:** tclcompiler versions prior to 2.0 (untested)
- **Recommended:** Use the latest tclcompiler version matching your target Tcl version

### Platform Binary Compatibility

The tbcload extension contains **native platform-specific code**:

- Windows binaries (`.dll`) only work on Windows
- Linux binaries (`.so`) only work on Linux
- macOS binaries (`.dylib`) only work on macOS
- The ABI must match your Tcl interpreter version

**Example ABI matching:**
- tbcload compiled against Tcl 8.6.13 → works with Tcl 8.6.x interpreters
- tbcload compiled for 64-bit → requires 64-bit Tcl interpreter

### Limitations

1. **Bytecode is not forward-compatible** - Code compiled for newer Tcl may not run on older versions
2. **Source-level reflection limited** - `info body` and similar introspection may not work fully
3. **Debugging challenges** - Debuggers cannot step through bytecode as easily as source
4. **No incremental updates** - Changing one procedure requires recompiling the entire file

---

## Security Considerations

### Important Security Warning

**Bytecode compilation is obfuscation, NOT encryption.**

### What Bytecode Protection Provides

- **Casual inspection protection** - Makes it harder to read code by opening the file in a text editor
- **Basic intellectual property protection** - Obscures algorithms from casual reverse engineering
- **Deterrent** - Raises the barrier for unauthorized code modification

### What Bytecode Does NOT Provide

- **Cryptographic security** - Bytecode can be disassembled
- **Complete source protection** - Tools exist to decompile bytecode
- **Tamper resistance** - Bytecode files can be modified by determined attackers
- **License enforcement** - Does not prevent unauthorized execution

### Recommendations

1. **Use for commercial distribution** - Suitable for shipping proprietary applications
2. **Don't rely on bytecode for security-critical secrets** - Don't embed passwords or keys in bytecode
3. **Combine with other measures:**
   - Code signing for integrity verification
   - License key systems for authorization
   - Network validation for high-value applications
4. **Keep runtime updated** - Update tbcload and Tcl when security patches are released

### Best Practices

```tcl
# BAD: Embedding sensitive credentials in bytecode
proc connect_database {} {
    # This is still readable through disassembly!
    set password "super_secret_123"
    db connect user password $password
}

# GOOD: Load credentials from secure external source
proc connect_database {} {
    # Read from encrypted config or environment
    set password [get_secure_credential "db_password"]
    db connect user password $password
}
```

---

## Performance Considerations

### Startup Performance

**Benefits:**
- **Faster loading** - Bytecode skips the parse/compilation phase
- **Reduced memory allocation** - Pre-compiled structures reduce initialization overhead
- **Faster application startup** - Noticeable improvement for large applications (>10,000 lines)

**Benchmarks (approximate):**

| Script Size | Source Load Time | Bytecode Load Time | Improvement |
|-------------|------------------|---------------------|-------------|
| 1,000 lines | ~10 ms | ~3 ms | 3x faster |
| 10,000 lines | ~100 ms | ~20 ms | 5x faster |
| 100,000 lines | ~1,000 ms | ~150 ms | 6-7x faster |

*Results vary by hardware and script complexity.*

### Runtime Performance

**Important:** Bytecode execution speed is **identical** to source execution speed.

- Once loaded, both run the same bytecode internally
- No runtime performance difference for computation-heavy code
- Benefits are primarily in loading/initialization phase

### File Size

Compiled bytecode files are typically **larger** than source files:

- `.tbc` files: ~2-3x larger than `.tcl` files
- Includes embedded metadata and bytecode structures
- Trade-off: larger distribution size for faster loading

### When to Use Bytecode

**Good use cases:**
- Commercial applications with many source files
- Applications where startup time matters
- Protecting proprietary algorithms
- Simplifying deployment (fewer files to manage)

**Not worth it for:**
- Tiny scripts (<100 lines)
- Scripts that change frequently during development
- Open-source projects where source is available anyway

---

## Troubleshooting

### Common Issues

#### 1. Package Not Found

**Error:**
```
can't find package tbcload
```

**Solutions:**
- Verify tbcload is installed: `ls [info library]/../tbcload*`
- Check auto_path: `puts $auto_path`
- Add installation directory: `lappend auto_path /path/to/tbcload`
- Ensure `pkgIndex.tcl` exists in the tbcload directory

---

#### 2. Invalid or Unsupported Bytecode

**Error:**
```
couldn't load file "hello.tbc": invalid or unsupported bytecode
```

**Possible Causes:**
- Bytecode compiled for different Tcl major version (8.x vs 9.x)
- File corruption during transfer
- Bytecode generated by old/incompatible tclcompiler
- Architecture mismatch (32-bit vs 64-bit)

**Solutions:**
```tcl
# Check your Tcl version
puts "Tcl version: [info patchlevel]"

# Recompile using matching tclcompiler
package require tclcompiler
compiler::compile hello.tcl

# Ensure binary mode for file transfers
# Use binary mode when copying .tbc files over network/FTP
```

---

#### 3. ABI Version Mismatch

**Error:**
```
version mismatch: tbcload requires Tcl 8.6, got 9.0
```

**Solution:**
- Install tbcload version matching your Tcl version
- Check: `info patchlevel` for your Tcl version
- Download or build tbcload for correct Tcl ABI

---

#### 4. Shared Library Load Failed

**Error (Linux):**
```
couldn't load file "libtbcload.so": libtcl8.6.so: cannot open shared object file
```

**Error (Windows):**
```
couldn't load library "tbcload.dll": The specified module could not be found
```

**Solutions:**

**Linux:**
```bash
# Check library dependencies
ldd /path/to/tbcload*/libtbcload.so

# Set LD_LIBRARY_PATH if needed
export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
```

**Windows:**
```cmd
# Ensure Tcl DLLs are in PATH or same directory as tbcload.dll
# Check with dependency walker or similar tool
```

---

#### 5. Bytecode Executes Differently Than Source

**Problem:** Bytecode behavior differs from source script

**Possible Causes:**
- Compiler bug (rare)
- Version mismatch between compile and runtime
- Use of unsupported features or introspection

**Debugging Steps:**
```tcl
# 1. Verify compilation succeeded without warnings
package require tclcompiler
compiler::compile -verbose script.tcl

# 2. Check Tcl version consistency
puts "Compiled with: [check tbc header]"
puts "Running on: [info patchlevel]"

# 3. Test with source first
source script.tcl  ;# Does this work?

# 4. Compare behavior
source script.tcl   ;# Source version
source script.tbc   ;# Bytecode version
```

---

#### 6. Debugging Bytecode Issues

**Problem:** Need to debug issues in compiled bytecode

**Techniques:**

1. **Use source during development:**
```tcl
if {$::debugging} {
    source script.tcl
} else {
    source script.tbc
}
```

2. **Add logging before compilation:**
```tcl
# Add debug output in source before compiling
proc my_function {arg} {
    puts stderr "DEBUG: my_function called with: $arg"
    # ... rest of function
}
```

3. **Recompile with latest compiler:**
```bash
# Update to latest tclcompiler
# Recompile with verbose output
```

---

### Getting Help

If you encounter issues:

1. **Verify versions:**
   ```tcl
   puts "Tcl: [info patchlevel]"
   puts "tbcload: [package require tbcload]"
   ```

2. **Check file integrity:**
   ```bash
   file script.tbc  # On Unix
   # Should say "TclPro ByteCode" or similar
   ```

3. **Test with simple script:**
   ```tcl
   # test.tcl
   puts "Hello from bytecode"

   # Compile and test
   package require tclcompiler
   compiler::compile test.tcl
   package require tbcload
   source test.tbc
   ```

4. **Consult resources:**
   - TclPro User's Guide (legacy but relevant)
   - tbcload GitHub repository
   - Tcl community forums

---

## Building from Source

If you need to build tbcload for your platform:

### Prerequisites

- **Tcl development headers** (`tcl-dev` or `tcl-devel`)
- **C compiler** (GCC, Clang, MSVC)
- **GNU Make**
- **autoconf** (if regenerating configure)

### Build Instructions (Unix/Linux/macOS)

```bash
# Clone or download source
cd /path/to/tbcload

# Generate configure script (if needed)
autoconf

# Configure for your Tcl installation
./configure --with-tcl=/usr/lib/tcl8.6

# Alternative: auto-detect Tcl
./configure

# Build
make

# Test (optional)
make test

# Install (requires sudo/root)
sudo make install
```

### Build Instructions (Windows with MinGW/MSYS2)

```bash
# Open MinGW/MSYS2 shell
cd /path/to/tbcload

# Configure
./configure --with-tcl=/c/Tcl/lib

# Build
make

# Install
make install

# Or manually copy to Tcl library directory
cp tbcload.dll pkgIndex.tcl /c/Tcl/lib/tbcload2.0/
```

### Build Instructions (Windows with MSVC)

```cmd
REM Open Visual Studio Command Prompt
cd C:\path\to\tbcload\win

REM Edit makefile.vc to set paths
REM Build
nmake -f makefile.vc

REM Install
nmake -f makefile.vc install
```

### Configuration Options

```bash
# Specify Tcl location
./configure --with-tcl=/path/to/tclConfig.sh

# Build in a separate directory
mkdir build && cd build
../configure
make

# Enable debugging symbols
./configure --enable-symbols

# Static linking
./configure --disable-shared
```

### Verification

```tcl
# After installation
package require tbcload
puts "Successfully built tbcload [package present tbcload]"
```

---

## Platform Support

The tbcload package supports all platforms where Tcl is available:

### Tested Platforms

- **Windows** - Windows 7/8/10/11 (32-bit and 64-bit)
- **Linux** - Major distributions (Debian, Ubuntu, Fedora, RHEL, CentOS, Arch)
- **macOS** - macOS 10.9+ (Intel and Apple Silicon)
- **BSD** - FreeBSD, OpenBSD, NetBSD
- **Unix** - Solaris, AIX, HP-UX

### Platform-Specific Notes

**Windows:**
- Requires `tbcload.dll` matching your Tcl version
- Visual Studio or MinGW builds available
- Compatible with Tcl/Tk distributed by ActiveState, Magicsplat

**Linux:**
- Shared library: `libtbcload.so`
- Usually packaged by distributions
- Build from source for custom Tcl builds

**macOS:**
- Universal binaries support both Intel and ARM
- Works with system Tcl or custom builds
- Shared library: `libtbcload.dylib`

---

## License

**BSD 3-Clause License**

Copyright (c) 1999-2000 Ajuba Solutions \
Copyright (c) 2018 ActiveState Software Inc.

Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:

1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.

2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.

3. Neither the name of the copyright holder nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

---

## Version History

- **2.0a0** (Current) - Tcl 9.0 support release
  - Added Tcl 9.0 compatibility
  - Updated for modern Tcl bytecode formats
  - Requires tclcompiler 2.0 or later
  - Previous tclcompiler versions unsupported

- **1.6.1** (2006-10-23)
  - Fixed initialization bug for Proc structures

- **1.6** (2006-09-11)
  - Added Tcl 8.5 support for compiled switch statements (JumpTableInfo)

- **1.4.0** (2002-09-30)
  - Added VAR_UNDEFINED flag for compatibility with Tcl 8.4 optimizations
  - Improved bytecode signature checking
  - Format version now matches interpreter version

- **Earlier versions** - See ChangeLog for historical releases from TclPro era

---

## Additional Resources

### Official Documentation

- [TclPro User's Guide - Chapter 6](https://www.tcl-lang.org/software/tclpro/doc/TclProUsersGuide14.pdf) - Comprehensive guide (legacy but applicable)
- [tbcload GitHub Repository](https://github.com/tcltk-depot/tbcload) - Source code and issue tracking

### Related Packages

- **tclcompiler** - Generates `.tbc` bytecode from `.tcl` source files (required companion)
- **TclDevKit** - Commercial suite including enhanced compiler and packaging tools
- **freewrap** - Application packager that works with tbcload

### Community Resources

- [Tcl Wiki - tbcload](https://wiki.tcl-lang.org/page/tbcload)
- [Tcl Community Discussion](https://groups.google.com/g/comp.lang.tcl)
- [Stack Overflow - Tcl tag](https://stackoverflow.com/questions/tagged/tcl)

### Related Topics

- Tcl bytecode internals and compilation
- Application deployment and packaging
- Code obfuscation techniques
- Tcl Extension Architecture (TEA)

---

## Quick Reference

### Basic Usage

```tcl
# Compile source to bytecode
package require tclcompiler
compiler::compile script.tcl         # Creates script.tbc

# Load and execute bytecode
package require tbcload
source script.tbc                    # Executes bytecode
```

### Common Patterns

```tcl
# Conditional loading (bytecode preferred)
if {[file exists script.tbc]} {
    package require tbcload
    source script.tbc
} else {
    source script.tcl
}

# Batch compilation
package require tclcompiler
foreach file [glob *.tcl] {
    compiler::compile $file
}

# Package with bytecode
package ifneeded MyPkg 1.0 [list apply {{dir} {
    package require tbcload
    source [file join $dir mypkg.tbc]
}} $dir]
```

### Remember

- **Version matching is critical** - Tcl 8.x bytecode won't run on Tcl 9.x
- **Platform-specific binaries** - tbcload must match your OS and Tcl ABI
- **Not cryptographic protection** - Bytecode is obfuscation, not encryption
- **Use latest tclcompiler** - Version 2.0+ required for supported bytecode
- **Transparent operation** - Once loaded, use standard `source` command

---

**Protect your Tcl code while maintaining performance!**
